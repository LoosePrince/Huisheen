<!DOCTYPE html>
<html lang="zh-CN" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>回声 (Huisheen) - 管理后台</title>
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        // Tailwind CSS暗黑模式配置
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        [v-cloak] { display: none; }
        .theme-transition {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen theme-transition">
    <div id="app" v-cloak>
        <!-- 顶部导航栏 -->
        <nav class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700 theme-transition">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center">
                            <img src="/logo.svg" alt="回声 Logo" class="w-8 h-8 mr-3">
                            <h1 class="text-xl font-bold text-gray-900 dark:text-white">回声 (Huisheen) - 管理后台</h1>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <span v-if="user" class="text-gray-700 dark:text-gray-300">
                            <i class="fas fa-user-shield mr-2"></i>{{ user.username }} (管理员)
                        </span>
                        <button @click="toggleDarkMode" 
                                class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 p-2 rounded-md transition-colors"
                                :title="darkMode ? '切换到日间模式' : '切换到夜间模式'">
                            <i v-if="darkMode" class="fas fa-sun text-xl"></i>
                            <i v-else class="fas fa-moon text-xl"></i>
                        </button>
                        <a href="/" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">
                            <i class="fas fa-home mr-2"></i>返回首页
                        </a>
                        <button v-if="user" @click="logout" 
                                class="bg-red-500 dark:bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-600 dark:hover:bg-red-700 transition">
                            <i class="fas fa-sign-out-alt mr-2"></i>退出登录
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主内容区域 -->
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <!-- 未登录或非管理员状态 -->
            <div v-if="!user || !user.isAdmin" class="text-center py-16">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 max-w-md mx-auto">
                    <i class="fas fa-lock text-6xl text-gray-400 dark:text-gray-500 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">管理员访问受限</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        您需要以管理员身份登录才能访问此页面。如果您是管理员，请登录后再尝试访问。
                    </p>
                    <div class="flex justify-center space-x-4">
                        <a href="/" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                            返回首页
                        </a>
                        <button v-if="!user" @click="showLoginForm = true" 
                                class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                            管理员登录
                        </button>
                    </div>
                </div>
            </div>

            <!-- 管理员内容 -->
            <div v-if="user && user.isAdmin" class="space-y-6">
                <!-- 欢迎信息 -->
                <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-500 dark:text-blue-400 text-xl mr-3"></i>
                        <div>
                            <h2 class="text-lg font-medium text-blue-800 dark:text-blue-300">欢迎访问管理后台</h2>
                            <p class="text-blue-600 dark:text-blue-400">
                                您已以管理员身份登录。上次刷新: {{ lastRefreshTime }}
                                <button @click="fetchStats" class="ml-2 text-blue-700 dark:text-blue-300 hover:text-blue-900 dark:hover:text-blue-200">
                                    <i class="fas fa-sync-alt" :class="{ 'fa-spin': loading }"></i> 刷新
                                </button>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 统计信息卡片 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                    <!-- 用户统计 -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border dark:border-gray-700 theme-transition">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">用户统计</h3>
                            <span class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full">
                                <i class="fas fa-user-plus mr-1"></i>今日: +{{ stats.users.newToday }}
                            </span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-14 h-14 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-users text-2xl text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">总用户数</p>
                                <p class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">{{ stats.users.total }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- 订阅统计 -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border dark:border-gray-700 theme-transition">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">订阅统计</h3>
                            <span class="text-xs bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 px-2 py-1 rounded-full">
                                <i class="fas fa-plus-circle mr-1"></i>今日: +{{ stats.subscriptions.newToday }}
                            </span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-14 h-14 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-link text-2xl text-green-600 dark:text-green-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">总订阅数</p>
                                <p class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">{{ stats.subscriptions.total }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- 消息统计 -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border dark:border-gray-700 theme-transition">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">消息统计</h3>
                            <span class="text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-200 px-2 py-1 rounded-full">
                                <i class="fas fa-bell mr-1"></i>今日: +{{ stats.notifications.newToday }}
                            </span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-14 h-14 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mr-4">
                                <i class="fas fa-envelope text-2xl text-purple-600 dark:text-purple-400"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">总消息数</p>
                                <p class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">{{ stats.notifications.total }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统信息 -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border dark:border-gray-700 theme-transition">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">系统信息</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">当前时间</div>
                            <div class="text-lg font-bold text-gray-900 dark:text-white">{{ getCurrentTime() }}</div>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">服务状态</div>
                            <div class="text-lg font-bold text-green-600 dark:text-green-400">运行中</div>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">平均消息/用户</div>
                            <div class="text-lg font-bold text-gray-900 dark:text-white">
                                {{ stats.users.total ? (stats.notifications.total / stats.users.total).toFixed(1) : 0 }}
                            </div>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="text-sm font-medium text-gray-500 dark:text-gray-400">平均订阅/用户</div>
                            <div class="text-lg font-bold text-gray-900 dark:text-white">
                                {{ stats.users.total ? (stats.subscriptions.total / stats.users.total).toFixed(1) : 0 }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 登录弹窗 -->
        <div v-if="showLoginForm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4 theme-transition">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">管理员登录</h3>
                    <button @click="showLoginForm = false" class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form @submit.prevent="login">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">邮箱</label>
                            <input v-model="loginForm.email" type="email" required 
                                   class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">密码</label>
                            <input v-model="loginForm.password" type="password" required 
                                   class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2">
                        </div>
                        <div v-if="loginError" class="text-red-500 text-sm">
                            {{ loginError }}
                        </div>
                        <button type="submit" :disabled="loading" 
                                class="w-full bg-blue-500 dark:bg-blue-600 text-white py-2 rounded-md hover:bg-blue-600 dark:hover:bg-blue-700 transition disabled:opacity-50">
                            <span v-if="loading"><i class="fas fa-spinner fa-spin mr-2"></i>登录中...</span>
                            <span v-else>登录</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 消息提示 -->
        <div v-if="message" 
             :class="message.type === 'success' ? 'bg-green-500' : 'bg-red-500'"
             class="fixed top-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg z-50">
            <div class="flex items-center">
                <i :class="message.type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'" class="mr-2"></i>
                {{ message.text }}
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed } = Vue;
        
        createApp({
            setup() {
                // 状态管理
                const darkMode = ref(localStorage.getItem('darkMode') === 'true' || false);
                const user = ref(null);
                const loading = ref(false);
                const showLoginForm = ref(false);
                const loginError = ref('');
                const token = ref(localStorage.getItem('token') || '');
                const message = ref(null);
                const stats = reactive({
                    users: { total: 0, newToday: 0 },
                    subscriptions: { total: 0, newToday: 0 },
                    notifications: { total: 0, newToday: 0 }
                });
                const lastRefreshTime = ref('--');
                
                const loginForm = reactive({
                    email: '',
                    password: ''
                });
                
                // 方法
                const toggleDarkMode = () => {
                    darkMode.value = !darkMode.value;
                    localStorage.setItem('darkMode', darkMode.value);
                    
                    if (darkMode.value) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                };
                
                const login = async () => {
                    try {
                        loading.value = true;
                        loginError.value = '';
                        
                        const response = await axios.post('/api/auth/login', loginForm);
                        
                        // 检查是否是管理员
                        if (!response.data.user.isAdmin) {
                            loginError.value = '该账户没有管理员权限';
                            return;
                        }
                        
                        token.value = response.data.token;
                        localStorage.setItem('token', token.value);
                        user.value = response.data.user;
                        
                        showLoginForm.value = false;
                        showMessage('登录成功', 'success');
                        
                        // 获取统计数据
                        fetchStats();
                    } catch (error) {
                        console.error('登录错误:', error);
                        loginError.value = error.response?.data?.error || '登录失败';
                    } finally {
                        loading.value = false;
                    }
                };
                
                const logout = () => {
                    token.value = '';
                    user.value = null;
                    localStorage.removeItem('token');
                    showMessage('已退出登录', 'success');
                };
                
                const fetchUser = async () => {
                    if (!token.value) return;
                    
                    try {
                        loading.value = true;
                        const response = await axios.get('/api/auth/me', {
                            headers: { Authorization: `Bearer ${token.value}` }
                        });
                        
                        user.value = response.data.user;
                        
                        // 如果不是管理员，清除token
                        if (!user.value.isAdmin) {
                            showMessage('该账户没有管理员权限', 'error');
                            token.value = '';
                            user.value = null;
                            localStorage.removeItem('token');
                        } else {
                            // 获取统计数据
                            fetchStats();
                        }
                    } catch (error) {
                        console.error('获取用户信息错误:', error);
                        // Token可能已过期，清除
                        if (error.response?.status === 401) {
                            token.value = '';
                            user.value = null;
                            localStorage.removeItem('token');
                        }
                    } finally {
                        loading.value = false;
                    }
                };
                
                const fetchStats = async () => {
                    if (!token.value || !user.value || !user.value.isAdmin) return;
                    
                    try {
                        loading.value = true;
                        const response = await axios.get('/api/admin/stats', {
                            headers: { Authorization: `Bearer ${token.value}` }
                        });
                        
                        // 更新统计数据
                        stats.users = response.data.users;
                        stats.subscriptions = response.data.subscriptions;
                        stats.notifications = response.data.notifications;
                        
                        // 更新刷新时间
                        lastRefreshTime.value = formatTime(new Date());
                    } catch (error) {
                        console.error('获取统计数据错误:', error);
                        showMessage('获取统计数据失败', 'error');
                    } finally {
                        loading.value = false;
                    }
                };
                
                const showMessage = (text, type = 'success') => {
                    message.value = { text, type };
                    setTimeout(() => {
                        message.value = null;
                    }, 3000);
                };
                
                const formatTime = (date) => {
                    if (!date) return '--';
                    if (typeof date === 'string') date = new Date(date);
                    
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                };
                
                const getCurrentTime = () => {
                    return formatTime(new Date());
                };
                
                // 生命周期钩子
                onMounted(() => {
                    // 初始化暗黑模式
                    if (darkMode.value) {
                        document.documentElement.classList.add('dark');
                    }
                    
                    // 自动登录
                    fetchUser();
                    
                    // 定时刷新统计数据（每5分钟）
                    setInterval(() => {
                        if (user.value && user.value.isAdmin) {
                            fetchStats();
                        }
                    }, 5 * 60 * 1000);
                });
                
                return {
                    darkMode,
                    user,
                    loading,
                    showLoginForm,
                    loginError,
                    loginForm,
                    message,
                    stats,
                    lastRefreshTime,
                    
                    toggleDarkMode,
                    login,
                    logout,
                    fetchStats,
                    getCurrentTime,
                    formatTime
                };
            }
        }).mount('#app');
    </script>
</body>
</html> 
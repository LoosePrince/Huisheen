<!DOCTYPE html>
<html lang="zh-CN" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>回声 (Huisheen) - 管理后台</title>
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        // Tailwind CSS暗黑模式配置
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        [v-cloak] { display: none; }
        .theme-transition {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen theme-transition">
    <div id="app" v-cloak>
        <!-- 顶部导航栏 -->
        <nav class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700 theme-transition">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center">
                            <img src="/logo.svg" alt="回声 Logo" class="w-8 h-8 mr-3">
                            <h1 class="text-xl font-bold text-gray-900 dark:text-white">回声 (Huisheen) - 管理后台</h1>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <span v-if="user" class="text-gray-700 dark:text-gray-300">
                            <i class="fas fa-user-shield mr-2"></i>{{ user.username }} (管理员)
                        </span>
                        <button @click="toggleDarkMode" 
                                class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 p-2 rounded-md transition-colors"
                                :title="darkMode ? '切换到日间模式' : '切换到夜间模式'">
                            <i v-if="darkMode" class="fas fa-sun text-xl"></i>
                            <i v-else class="fas fa-moon text-xl"></i>
                        </button>
                        <a href="/" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300">
                            <i class="fas fa-home mr-2"></i>返回首页
                        </a>
                        <button v-if="user" @click="logout" 
                                class="bg-red-500 dark:bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-600 dark:hover:bg-red-700 transition">
                            <i class="fas fa-sign-out-alt mr-2"></i>退出登录
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- 主内容区域 -->
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <!-- 未登录或非管理员状态 -->
            <div v-if="!user || !user.isAdmin" class="text-center py-16">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8 max-w-md mx-auto">
                    <i class="fas fa-lock text-6xl text-gray-400 dark:text-gray-500 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">管理员访问受限</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        您需要以管理员身份登录才能访问此页面。如果您是管理员，请登录后再尝试访问。
                    </p>
                    <div class="flex justify-center space-x-4">
                        <a href="/" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                            返回首页
                        </a>
                        <button v-if="!user" @click="showLoginForm = true" 
                                class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                            管理员登录
                        </button>
                    </div>
                </div>
            </div>

            <!-- 管理员内容 -->
            <div v-if="user && user.isAdmin" class="space-y-6">
                <!-- 导航选项卡 -->
                <div class="border-b border-gray-200 dark:border-gray-700">
                    <nav class="flex -mb-px">
                        <button @click="activeTab = 'dashboard'" :class="[
                            activeTab === 'dashboard' 
                                ? 'border-blue-500 text-blue-600 dark:text-blue-400' 
                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600',
                            'py-4 px-6 border-b-2 font-medium text-sm focus:outline-none transition-colors'
                        ]">
                            <i class="fas fa-chart-bar mr-2"></i>仪表盘
                        </button>
                        <button @click="activeTab = 'users'" :class="[
                            activeTab === 'users' 
                                ? 'border-blue-500 text-blue-600 dark:text-blue-400' 
                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600',
                            'py-4 px-6 border-b-2 font-medium text-sm focus:outline-none transition-colors'
                        ]">
                            <i class="fas fa-users mr-2"></i>用户管理
                        </button>
                        <button @click="activeTab = 'services'" :class="[
                            activeTab === 'services' 
                                ? 'border-blue-500 text-blue-600 dark:text-blue-400' 
                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300 dark:hover:border-gray-600',
                            'py-4 px-6 border-b-2 font-medium text-sm focus:outline-none transition-colors'
                        ]">
                            <i class="fas fa-server mr-2"></i>服务管理
                        </button>
                    </nav>
                </div>

                <!-- 欢迎信息 -->
                <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-500 dark:text-blue-400 text-xl mr-3"></i>
                        <div>
                            <h2 class="text-lg font-medium text-blue-800 dark:text-blue-300">欢迎访问管理后台</h2>
                            <p class="text-blue-600 dark:text-blue-400">
                                您已以管理员身份登录。上次刷新: {{ lastRefreshTime }}
                                <button @click="refreshData" class="ml-2 text-blue-700 dark:text-blue-300 hover:text-blue-900 dark:hover:text-blue-200">
                                    <i class="fas fa-sync-alt" :class="{ 'fa-spin': loading }"></i> 刷新
                                </button>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 仪表盘内容 -->
                <div v-if="activeTab === 'dashboard'">
                    <!-- 统计信息卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                        <!-- 用户统计 -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border dark:border-gray-700 theme-transition">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white">用户统计</h3>
                                <span class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full">
                                    <i class="fas fa-user-plus mr-1"></i>今日: +{{ stats.users.newToday }}
                                </span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-14 h-14 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-users text-2xl text-blue-600 dark:text-blue-400"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">总用户数</p>
                                    <p class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">{{ stats.users.total }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- 订阅统计 -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border dark:border-gray-700 theme-transition">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white">订阅统计</h3>
                                <span class="text-xs bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 px-2 py-1 rounded-full">
                                    <i class="fas fa-plus-circle mr-1"></i>今日: +{{ stats.subscriptions.newToday }}
                                </span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-14 h-14 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-link text-2xl text-green-600 dark:text-green-400"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">总订阅数</p>
                                    <p class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">{{ stats.subscriptions.total }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- 消息统计 -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border dark:border-gray-700 theme-transition">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-medium text-gray-900 dark:text-white">消息统计</h3>
                                <span class="text-xs bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-200 px-2 py-1 rounded-full">
                                    <i class="fas fa-bell mr-1"></i>今日: +{{ stats.notifications.newToday }}
                                </span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-14 h-14 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mr-4">
                                    <i class="fas fa-envelope text-2xl text-purple-600 dark:text-purple-400"></i>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">总消息数</p>
                                    <p class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">{{ stats.notifications.total }}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系统信息 -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border dark:border-gray-700 theme-transition mt-6">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">系统信息</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">当前时间</div>
                                <div class="text-lg font-bold text-gray-900 dark:text-white">{{ getCurrentTime() }}</div>
                            </div>
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">服务状态</div>
                                <div class="text-lg font-bold text-green-600 dark:text-green-400">运行中</div>
                            </div>
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">平均消息/用户</div>
                                <div class="text-lg font-bold text-gray-900 dark:text-white">
                                    {{ stats.users.total ? (stats.notifications.total / stats.users.total).toFixed(1) : 0 }}
                                </div>
                            </div>
                            <div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">平均订阅/用户</div>
                                <div class="text-lg font-bold text-gray-900 dark:text-white">
                                    {{ stats.users.total ? (stats.subscriptions.total / stats.users.total).toFixed(1) : 0 }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 用户管理内容 -->
                <div v-if="activeTab === 'users'" class="space-y-6">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border dark:border-gray-700 theme-transition">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">用户管理</h3>
                            <div class="flex items-center space-x-2">
                                <div class="relative">
                                    <input v-model="userSearch" type="text" placeholder="搜索用户..." 
                                        class="pr-10 pl-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-sm">
                                    <span class="absolute right-3 top-2 text-gray-400">
                                        <i class="fas fa-search"></i>
                                    </span>
                                </div>
                                <button @click="fetchUsers" class="bg-blue-500 dark:bg-blue-600 text-white px-3 py-2 rounded-md text-sm hover:bg-blue-600 dark:hover:bg-blue-700 transition">
                                    <i class="fas fa-sync-alt" :class="{ 'fa-spin': usersLoading }"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 用户列表 -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">用户</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">邮箱</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">状态</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">注册时间</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr v-if="usersLoading" class="animate-pulse">
                                        <td colspan="5" class="px-6 py-4">
                                            <div class="h-4 bg-gray-200 dark:bg-gray-600 rounded w-3/4"></div>
                                        </td>
                                    </tr>
                                    <tr v-else-if="!userList.length" class="text-center">
                                        <td colspan="5" class="px-6 py-4 text-gray-500 dark:text-gray-400">
                                            暂无用户数据
                                        </td>
                                    </tr>
                                    <tr v-for="user in filteredUsers" :key="user._id" class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/40 rounded-full flex items-center justify-center text-blue-600 dark:text-blue-400 font-bold">
                                                    {{ user.username.charAt(0).toUpperCase() }}
                                                </div>
                                                <div class="ml-3">
                                                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                                                        {{ user.username }}
                                                    </div>
                                                    <div class="text-xs text-gray-500 dark:text-gray-400">
                                                        {{ user.notifyId }}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900 dark:text-white">{{ user.email }}</div>
                                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                                <span v-if="user.isEmailVerified" class="text-green-600 dark:text-green-400">
                                                    <i class="fas fa-check-circle mr-1"></i>已验证
                                                </span>
                                                <span v-else class="text-yellow-600 dark:text-yellow-400">
                                                    <i class="fas fa-exclamation-circle mr-1"></i>未验证
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span v-if="user.isActive" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-400">
                                                <i class="fas fa-circle text-xs mr-1"></i>
                                                正常
                                            </span>
                                            <span v-else class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/40 text-red-800 dark:text-red-400">
                                                <i class="fas fa-ban text-xs mr-1"></i>
                                                已禁用
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                            {{ formatTime(user.createdAt) }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                            <button v-if="user.isActive" @click="confirmDisableUser(user)" 
                                                    class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 transition-colors">
                                                <i class="fas fa-ban mr-1"></i>禁用
                                            </button>
                                            <button v-else @click="confirmEnableUser(user)"
                                                    class="text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300 transition-colors">
                                                <i class="fas fa-check mr-1"></i>解禁
                                            </button>
                                            <button @click="openSendNotificationModal(user)"
                                                    class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors">
                                                <i class="fas fa-bell mr-1"></i>发送通知
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分页控件 -->
                        <div class="flex justify-between items-center mt-4">
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                显示 {{ userList.length }} 个用户
                            </div>
                            <div class="flex space-x-2">
                                <button @click="userPage > 1 && (userPage--)" :disabled="userPage === 1"
                                        class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 disabled:opacity-50">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded-md text-gray-700 dark:text-gray-300">
                                    {{ userPage }}
                                </span>
                                <button @click="userPage++" :disabled="userList.length < userPageSize.value"
                                        class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 disabled:opacity-50">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 服务管理内容 -->
                <div v-if="activeTab === 'services'" class="space-y-6">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 border dark:border-gray-700 theme-transition">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white">服务管理</h3>
                            <div class="flex items-center space-x-2">
                                <div class="relative">
                                    <input v-model="serviceSearch" type="text" placeholder="搜索服务..." 
                                        class="pr-10 pl-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md text-sm">
                                    <span class="absolute right-3 top-2 text-gray-400">
                                        <i class="fas fa-search"></i>
                                    </span>
                                </div>
                                <button @click="fetchServices" class="bg-blue-500 dark:bg-blue-600 text-white px-3 py-2 rounded-md text-sm hover:bg-blue-600 dark:hover:bg-blue-700 transition">
                                    <i class="fas fa-sync-alt" :class="{ 'fa-spin': servicesLoading }"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 服务统计信息 -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">总服务数</div>
                                <div class="text-2xl font-bold text-gray-900 dark:text-white">{{ serviceList.length }}</div>
                            </div>
                            <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">已禁用服务</div>
                                <div class="text-2xl font-bold text-red-600 dark:text-red-400">{{ serviceList.filter(s => !s.isActive).length }}</div>
                            </div>
                            <div class="p-4 rounded-lg bg-gray-50 dark:bg-gray-700">
                                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">活跃服务</div>
                                <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ serviceList.filter(s => s.isActive).length }}</div>
                            </div>
                        </div>
                        
                        <!-- 服务列表 -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">服务</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">主机</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">订阅</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">模式</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">状态</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">操作</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <tr v-if="servicesLoading" class="animate-pulse">
                                        <td colspan="6" class="px-6 py-4">
                                            <div class="h-4 bg-gray-200 dark:bg-gray-600 rounded w-3/4"></div>
                                        </td>
                                    </tr>
                                    <tr v-else-if="!serviceList.length" class="text-center">
                                        <td colspan="6" class="px-6 py-4 text-gray-500 dark:text-gray-400">
                                            暂无服务数据
                                        </td>
                                    </tr>
                                    <tr v-for="service in filteredServices" :key="service._id" class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900/40 rounded-full flex items-center justify-center text-purple-600 dark:text-purple-400">
                                                    <i class="fas fa-server"></i>
                                                </div>
                                                <div class="ml-3">
                                                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                                                        {{ service.name }}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900 dark:text-white">{{ service._id }}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                            {{ service.count }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex space-x-1">
                                                <span v-if="service.activeMode" class="px-2 py-1 text-xs rounded-md bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-300">
                                                    主动 ({{ service.activeMode }})
                                                </span>
                                                <span v-if="service.passive" class="px-2 py-1 text-xs rounded-md bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-300">
                                                    被动 ({{ service.passive }})
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span v-if="service.isActive" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-400">
                                                <i class="fas fa-circle text-xs mr-1"></i>
                                                正常
                                            </span>
                                            <span v-else class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/40 text-red-800 dark:text-red-400">
                                                <i class="fas fa-ban text-xs mr-1"></i>
                                                已禁用
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                            <button v-if="service.isActive" @click="confirmDisableService(service)" 
                                                    class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 transition-colors">
                                                <i class="fas fa-ban mr-1"></i>禁用
                                            </button>
                                            <button v-else @click="confirmEnableService(service)"
                                                    class="text-green-600 dark:text-green-400 hover:text-green-800 dark:hover:text-green-300 transition-colors">
                                                <i class="fas fa-check mr-1"></i>解禁
                                            </button>
                                            <button @click="showServiceDetails(service)"
                                                    class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors">
                                                <i class="fas fa-info-circle mr-1"></i>详情
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 登录弹窗 -->
        <div v-if="showLoginForm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4 theme-transition">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">管理员登录</h3>
                    <button @click="showLoginForm = false" class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form @submit.prevent="login">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">邮箱</label>
                            <input v-model="loginForm.email" type="email" required 
                                   class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">密码</label>
                            <input v-model="loginForm.password" type="password" required 
                                   class="mt-1 block w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2">
                        </div>
                        <div v-if="loginError" class="text-red-500 text-sm">
                            {{ loginError }}
                        </div>
                        <button type="submit" :disabled="loading" 
                                class="w-full bg-blue-500 dark:bg-blue-600 text-white py-2 rounded-md hover:bg-blue-600 dark:hover:bg-blue-700 transition disabled:opacity-50">
                            <span v-if="loading"><i class="fas fa-spinner fa-spin mr-2"></i>登录中...</span>
                            <span v-else>登录</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 消息提示 -->
        <div v-if="message" 
             :class="message.type === 'success' ? 'bg-green-500' : 'bg-red-500'"
             class="fixed top-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg z-50">
            <div class="flex items-center">
                <i :class="message.type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'" class="mr-2"></i>
                {{ message.text }}
            </div>
        </div>

        <!-- 禁用用户确认弹窗 -->
        <div v-if="showDisableUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4 theme-transition">
                <div class="text-center mb-4">
                    <div class="w-12 h-12 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-user-slash text-red-600 dark:text-red-400 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">确认禁用用户</h3>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                        您确定要禁用用户 <span class="font-semibold">{{ selectedUser?.username }}</span> 吗？禁用后，该用户将无法登录系统。
                    </p>
                </div>
                <div class="mt-5 flex justify-center space-x-3">
                    <button @click="showDisableUserModal = false" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        取消
                    </button>
                    <button @click="disableUser" :disabled="loading" class="px-4 py-2 bg-red-500 dark:bg-red-600 text-white rounded-md hover:bg-red-600 dark:hover:bg-red-700 transition-colors disabled:opacity-50">
                        <span v-if="loading"><i class="fas fa-spinner fa-spin mr-2"></i>处理中...</span>
                        <span v-else>确认禁用</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 解禁用户确认弹窗 -->
        <div v-if="showEnableUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4 theme-transition">
                <div class="text-center mb-4">
                    <div class="w-12 h-12 bg-green-100 dark:bg-green-900/40 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-user-check text-green-600 dark:text-green-400 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">确认解禁用户</h3>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                        您确定要解禁用户 <span class="font-semibold">{{ selectedUser?.username }}</span> 吗？解禁后，该用户将可以正常登录系统。
                    </p>
                </div>
                <div class="mt-5 flex justify-center space-x-3">
                    <button @click="showEnableUserModal = false" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        取消
                    </button>
                    <button @click="enableUser" :disabled="loading" class="px-4 py-2 bg-green-500 dark:bg-green-600 text-white rounded-md hover:bg-green-600 dark:hover:bg-green-700 transition-colors disabled:opacity-50">
                        <span v-if="loading"><i class="fas fa-spinner fa-spin mr-2"></i>处理中...</span>
                        <span v-else>确认解禁</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 发送系统通知弹窗 -->
        <div v-if="showSendNotificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4 theme-transition">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">发送系统通知</h3>
                    <button @click="showSendNotificationModal = false" class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form @submit.prevent="sendNotification">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">接收用户</label>
                            <div class="py-2 px-3 bg-gray-100 dark:bg-gray-700 rounded-md text-gray-800 dark:text-gray-300">
                                {{ selectedUser?.username }} ({{ selectedUser?.email }})
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">通知标题</label>
                            <input v-model="notificationForm.title" type="text" required 
                                   class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">通知内容</label>
                            <textarea v-model="notificationForm.content" rows="4" required 
                                      class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">通知类型</label>
                            <select v-model="notificationForm.type" 
                                    class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2">
                                <option value="info">信息 (info)</option>
                                <option value="success">成功 (success)</option>
                                <option value="warning">警告 (warning)</option>
                                <option value="error">错误 (error)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">优先级</label>
                            <select v-model="notificationForm.priority" 
                                    class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md px-3 py-2">
                                <option value="low">低 (low)</option>
                                <option value="normal">普通 (normal)</option>
                                <option value="high">高 (high)</option>
                                <option value="urgent">紧急 (urgent)</option>
                            </select>
                        </div>
                        <button type="submit" :disabled="loading" 
                                class="w-full bg-blue-500 dark:bg-blue-600 text-white py-2 rounded-md hover:bg-blue-600 dark:hover:bg-blue-700 transition disabled:opacity-50">
                            <span v-if="loading"><i class="fas fa-spinner fa-spin mr-2"></i>发送中...</span>
                            <span v-else>发送通知</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 禁用服务确认弹窗 -->
        <div v-if="showDisableServiceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4 theme-transition">
                <div class="text-center mb-4">
                    <div class="w-12 h-12 bg-red-100 dark:bg-red-900/40 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-server-slash text-red-600 dark:text-red-400 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">确认禁用服务</h3>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                        您确定要禁用服务 <span class="font-semibold">{{ selectedService?.name }}</span> 吗？禁用后：
                    </p>
                    <ul class="mt-3 text-left text-sm text-gray-500 dark:text-gray-400 space-y-1 bg-gray-50 dark:bg-gray-700 p-3 rounded-md">
                        <li>• 用户将无法添加该服务的新订阅</li>
                        <li>• 系统将不再轮询该服务获取通知</li>
                        <li>• 该服务发送的推送通知将被拒绝</li>
                        <li>• 用户现有订阅会显示"暂时无法使用该服务"</li>
                    </ul>
                </div>
                <div class="mt-5 flex justify-center space-x-3">
                    <button @click="showDisableServiceModal = false" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        取消
                    </button>
                    <button @click="disableService" :disabled="loading" class="px-4 py-2 bg-red-500 dark:bg-red-600 text-white rounded-md hover:bg-red-600 dark:hover:bg-red-700 transition-colors disabled:opacity-50">
                        <span v-if="loading"><i class="fas fa-spinner fa-spin mr-2"></i>处理中...</span>
                        <span v-else>确认禁用</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 解禁服务确认弹窗 -->
        <div v-if="showEnableServiceModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4 theme-transition">
                <div class="text-center mb-4">
                    <div class="w-12 h-12 bg-green-100 dark:bg-green-900/40 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-server text-green-600 dark:text-green-400 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">确认解禁服务</h3>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                        您确定要解禁服务 <span class="font-semibold">{{ selectedService?.name }}</span> 吗？解禁后，该服务将恢复正常运行。
                    </p>
                </div>
                <div class="mt-5 flex justify-center space-x-3">
                    <button @click="showEnableServiceModal = false" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        取消
                    </button>
                    <button @click="enableService" :disabled="loading" class="px-4 py-2 bg-green-500 dark:bg-green-600 text-white rounded-md hover:bg-green-600 dark:hover:bg-green-700 transition-colors disabled:opacity-50">
                        <span v-if="loading"><i class="fas fa-spinner fa-spin mr-2"></i>处理中...</span>
                        <span v-else>确认解禁</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 服务详情弹窗 -->
        <div v-if="showServiceDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-2xl mx-4 theme-transition">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">服务详情</h3>
                    <button @click="showServiceDetailsModal = false" class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div v-if="selectedService" class="space-y-6">
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">基本信息</h4>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-md p-4 space-y-3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">服务名称</div>
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">{{ selectedService.name }}</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">主机</div>
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">{{ selectedService._id }}</div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">状态</div>
                                    <div class="text-sm font-medium">
                                        <span v-if="selectedService.isActive" class="text-green-600 dark:text-green-400">
                                            <i class="fas fa-circle text-xs mr-1"></i>正常
                                        </span>
                                        <span v-else class="text-red-600 dark:text-red-400">
                                            <i class="fas fa-ban text-xs mr-1"></i>已禁用
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">总订阅数</div>
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">{{ selectedService.count }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">订阅详情</h4>
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-md p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">主动模式订阅</div>
                                <div class="text-sm font-medium text-gray-900 dark:text-white">{{ selectedService.activeMode || 0 }}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">被动模式订阅</div>
                                <div class="text-sm font-medium text-gray-900 dark:text-white">{{ selectedService.passive || 0 }}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">活跃订阅</div>
                                <div class="text-sm font-medium text-gray-900 dark:text-white">{{ selectedService.active || 0 }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button @click="showServiceDetailsModal = false" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        关闭
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted, computed, watch } = Vue;
        
        createApp({
            setup() {
                // 状态管理
                const darkMode = ref(localStorage.getItem('darkMode') === 'true' || false);
                const user = ref(null);
                const loading = ref(false);
                const showLoginForm = ref(false);
                const loginError = ref('');
                const token = ref(localStorage.getItem('token') || '');
                const message = ref(null);
                const stats = reactive({
                    users: { total: 0, newToday: 0 },
                    subscriptions: { total: 0, newToday: 0 },
                    notifications: { total: 0, newToday: 0 }
                });
                const lastRefreshTime = ref('--');
                
                const loginForm = reactive({
                    email: '',
                    password: ''
                });
                
                const activeTab = ref('dashboard');
                
                // 用户管理
                const userList = ref([]);
                const userSearch = ref('');
                const userPage = ref(1);
                const userPageSize = ref(10);
                const usersLoading = ref(false);
                const selectedUser = ref(null);
                const showDisableUserModal = ref(false);
                const showEnableUserModal = ref(false);
                const showSendNotificationModal = ref(false);
                
                const notificationForm = reactive({
                    title: '',
                    content: '',
                    type: 'info',
                    priority: 'normal'
                });
                
                const filteredUsers = computed(() => {
                    if (!userSearch.value) return userList.value;
                    
                    const search = userSearch.value.toLowerCase();
                    return userList.value.filter(user => 
                        user.username.toLowerCase().includes(search) || 
                        user.email.toLowerCase().includes(search) ||
                        user.notifyId.toLowerCase().includes(search)
                    );
                });
                
                // 服务管理
                const serviceList = ref([]);
                const serviceSearch = ref('');
                const servicesLoading = ref(false);
                const selectedService = ref(null);
                const showDisableServiceModal = ref(false);
                const showEnableServiceModal = ref(false);
                const showServiceDetailsModal = ref(false);
                
                const filteredServices = computed(() => {
                    if (!serviceSearch.value) return serviceList.value;
                    
                    const search = serviceSearch.value.toLowerCase();
                    return serviceList.value.filter(service => 
                        service.name.toLowerCase().includes(search) || 
                        service._id.toLowerCase().includes(search)
                    );
                });
                
                // 方法
                const toggleDarkMode = () => {
                    darkMode.value = !darkMode.value;
                    localStorage.setItem('darkMode', darkMode.value);
                    
                    if (darkMode.value) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                };
                
                const login = async () => {
                    try {
                        loading.value = true;
                        loginError.value = '';
                        
                        const response = await axios.post('/api/auth/login', loginForm);
                        
                        // 检查是否是管理员
                        if (!response.data.user.isAdmin) {
                            loginError.value = '该账户没有管理员权限';
                            return;
                        }
                        
                        token.value = response.data.token;
                        localStorage.setItem('token', token.value);
                        user.value = response.data.user;
                        
                        showLoginForm.value = false;
                        showMessage('登录成功', 'success');
                        
                        // 获取统计数据
                        fetchStats();
                    } catch (error) {
                        console.error('登录错误:', error);
                        loginError.value = error.response?.data?.error || '登录失败';
                    } finally {
                        loading.value = false;
                    }
                };
                
                const logout = () => {
                    token.value = '';
                    user.value = null;
                    localStorage.removeItem('token');
                    showMessage('已退出登录', 'success');
                };
                
                const fetchUser = async () => {
                    if (!token.value) return;
                    
                    try {
                        loading.value = true;
                        const response = await axios.get('/api/auth/me', {
                            headers: { Authorization: `Bearer ${token.value}` }
                        });
                        
                        user.value = response.data.user;
                        
                        // 如果不是管理员，清除token
                        if (!user.value.isAdmin) {
                            showMessage('该账户没有管理员权限', 'error');
                            token.value = '';
                            user.value = null;
                            localStorage.removeItem('token');
                        } else {
                            // 获取统计数据
                            fetchStats();
                        }
                    } catch (error) {
                        console.error('获取用户信息错误:', error);
                        // Token可能已过期，清除
                        if (error.response?.status === 401) {
                            token.value = '';
                            user.value = null;
                            localStorage.removeItem('token');
                        }
                    } finally {
                        loading.value = false;
                    }
                };
                
                const fetchStats = async () => {
                    if (!token.value || !user.value || !user.value.isAdmin) return;
                    
                    try {
                        loading.value = true;
                        const response = await axios.get('/api/admin/stats', {
                            headers: { Authorization: `Bearer ${token.value}` }
                        });
                        
                        // 更新统计数据
                        stats.users = response.data.users;
                        stats.subscriptions = response.data.subscriptions;
                        stats.notifications = response.data.notifications;
                        
                        // 更新刷新时间
                        lastRefreshTime.value = formatTime(new Date());
                    } catch (error) {
                        console.error('获取统计数据错误:', error);
                        showMessage('获取统计数据失败', 'error');
                    } finally {
                        loading.value = false;
                    }
                };
                
                const showMessage = (text, type = 'success') => {
                    message.value = { text, type };
                    setTimeout(() => {
                        message.value = null;
                    }, 3000);
                };
                
                const formatTime = (date) => {
                    if (!date) return '--';
                    if (typeof date === 'string') date = new Date(date);
                    
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                };
                
                const getCurrentTime = () => {
                    return formatTime(new Date());
                };
                
                const refreshData = async () => {
                    if (activeTab.value === 'dashboard') {
                        await fetchStats();
                    } else if (activeTab.value === 'users') {
                        await fetchUsers();
                    } else if (activeTab.value === 'services') {
                        await fetchServices();
                    }
                };
                
                const fetchUsers = async () => {
                    if (!token.value) return;
                    
                    try {
                        usersLoading.value = true;
                        const response = await axios.get('/api/admin/users', {
                            headers: { Authorization: `Bearer ${token.value}` },
                            params: { page: userPage.value, limit: userPageSize.value }
                        });
                        
                        console.log('用户列表数据:', response.data);
                        userList.value = response.data.users;
                    } catch (error) {
                        console.error('获取用户列表错误:', error);
                        showMessage('获取用户列表失败: ' + (error.response?.data?.error || error.message), 'error');
                    } finally {
                        usersLoading.value = false;
                    }
                };
                
                const confirmDisableUser = (user) => {
                    selectedUser.value = user;
                    showDisableUserModal.value = true;
                };
                
                const confirmEnableUser = (user) => {
                    selectedUser.value = user;
                    showEnableUserModal.value = true;
                };
                
                const disableUser = async () => {
                    if (!selectedUser.value) return;
                    
                    try {
                        loading.value = true;
                        await axios.patch(`/api/admin/users/${selectedUser.value._id}/status`, 
                            { isActive: false },
                            { headers: { Authorization: `Bearer ${token.value}` } }
                        );
                        
                        // 更新本地用户列表
                        const userIndex = userList.value.findIndex(u => u._id === selectedUser.value._id);
                        if (userIndex !== -1) {
                            userList.value[userIndex].isActive = false;
                        }
                        
                        showMessage(`用户 ${selectedUser.value.username} 已被禁用`, 'success');
                        showDisableUserModal.value = false;
                    } catch (error) {
                        console.error('禁用用户错误:', error);
                        showMessage('禁用用户失败: ' + (error.response?.data?.error || error.message), 'error');
                    } finally {
                        loading.value = false;
                    }
                };
                
                const enableUser = async () => {
                    if (!selectedUser.value) return;
                    
                    try {
                        loading.value = true;
                        await axios.patch(`/api/admin/users/${selectedUser.value._id}/status`, 
                            { isActive: true },
                            { headers: { Authorization: `Bearer ${token.value}` } }
                        );
                        
                        // 更新本地用户列表
                        const userIndex = userList.value.findIndex(u => u._id === selectedUser.value._id);
                        if (userIndex !== -1) {
                            userList.value[userIndex].isActive = true;
                        }
                        
                        showMessage(`用户 ${selectedUser.value.username} 已被解禁`, 'success');
                        showEnableUserModal.value = false;
                    } catch (error) {
                        console.error('解禁用户错误:', error);
                        showMessage('解禁用户失败: ' + (error.response?.data?.error || error.message), 'error');
                    } finally {
                        loading.value = false;
                    }
                };
                
                const openSendNotificationModal = (user) => {
                    selectedUser.value = user;
                    // 重置表单
                    notificationForm.title = '';
                    notificationForm.content = '';
                    notificationForm.type = 'info';
                    notificationForm.priority = 'normal';
                    showSendNotificationModal.value = true;
                };
                
                const sendNotification = async () => {
                    if (!selectedUser.value) return;
                    
                    try {
                        loading.value = true;
                        await axios.post(`/api/admin/notifications/send`, 
                            {
                                userId: selectedUser.value._id,
                                title: notificationForm.title,
                                content: notificationForm.content,
                                type: notificationForm.type,
                                priority: notificationForm.priority,
                                source: { name: '系统通知' }
                            },
                            { headers: { Authorization: `Bearer ${token.value}` } }
                        );
                        
                        showMessage(`已向用户 ${selectedUser.value.username} 发送通知`, 'success');
                        showSendNotificationModal.value = false;
                    } catch (error) {
                        console.error('发送通知错误:', error);
                        showMessage('发送通知失败: ' + (error.response?.data?.error || error.message), 'error');
                    } finally {
                        loading.value = false;
                    }
                };
                
                const fetchServices = async () => {
                    if (!token.value) return;
                    
                    try {
                        servicesLoading.value = true;
                        const response = await axios.get('/api/admin/services', {
                            headers: { Authorization: `Bearer ${token.value}` }
                        });
                        
                        console.log('服务列表数据:', response.data);
                        
                        // 添加isActive字段，如果没有则默认为true
                        serviceList.value = response.data.services.map(service => ({
                            ...service,
                            isActive: service.isActive !== undefined ? service.isActive : true
                        }));
                    } catch (error) {
                        console.error('获取服务列表错误:', error);
                        showMessage('获取服务列表失败: ' + (error.response?.data?.error || error.message), 'error');
                    } finally {
                        servicesLoading.value = false;
                    }
                };
                
                const confirmDisableService = (service) => {
                    selectedService.value = service;
                    showDisableServiceModal.value = true;
                };
                
                const confirmEnableService = (service) => {
                    selectedService.value = service;
                    showEnableServiceModal.value = true;
                };
                
                const disableService = async () => {
                    if (!selectedService.value) return;
                    
                    try {
                        loading.value = true;
                        await axios.patch(`/api/admin/services/status`, 
                            { 
                                serviceId: selectedService.value._id,
                                isActive: false 
                            },
                            { headers: { Authorization: `Bearer ${token.value}` } }
                        );
                        
                        // 更新本地服务列表
                        const serviceIndex = serviceList.value.findIndex(s => s._id === selectedService.value._id);
                        if (serviceIndex !== -1) {
                            serviceList.value[serviceIndex].isActive = false;
                        }
                        
                        showMessage(`服务 ${selectedService.value.name} 已被禁用`, 'success');
                        showDisableServiceModal.value = false;
                    } catch (error) {
                        console.error('禁用服务错误:', error);
                        showMessage('禁用服务失败: ' + (error.response?.data?.error || error.message), 'error');
                    } finally {
                        loading.value = false;
                    }
                };
                
                const enableService = async () => {
                    if (!selectedService.value) return;
                    
                    try {
                        loading.value = true;
                        await axios.patch(`/api/admin/services/status`, 
                            { 
                                serviceId: selectedService.value._id,
                                isActive: true 
                            },
                            { headers: { Authorization: `Bearer ${token.value}` } }
                        );
                        
                        // 更新本地服务列表
                        const serviceIndex = serviceList.value.findIndex(s => s._id === selectedService.value._id);
                        if (serviceIndex !== -1) {
                            serviceList.value[serviceIndex].isActive = true;
                        }
                        
                        showMessage(`服务 ${selectedService.value.name} 已被解禁`, 'success');
                        showEnableServiceModal.value = false;
                    } catch (error) {
                        console.error('解禁服务错误:', error);
                        showMessage('解禁服务失败: ' + (error.response?.data?.error || error.message), 'error');
                    } finally {
                        loading.value = false;
                    }
                };
                
                const showServiceDetails = (service) => {
                    selectedService.value = service;
                    showServiceDetailsModal.value = true;
                };
                
                // 生命周期钩子
                onMounted(() => {
                    // 初始化暗黑模式
                    if (darkMode.value) {
                        document.documentElement.classList.add('dark');
                    }
                    
                    // 自动登录
                    fetchUser();
                    
                    // 定时刷新统计数据（每5分钟）
                    setInterval(() => {
                        if (user.value && user.value.isAdmin) {
                            fetchStats();
                        }
                    }, 5 * 60 * 1000);
                    
                    // 监听activeTab变化，加载对应数据
                    watch(activeTab, (newTab) => {
                        if (newTab === 'users') {
                            fetchUsers();
                        } else if (newTab === 'services') {
                            fetchServices();
                        }
                    });
                });
                
                return {
                    darkMode,
                    user,
                    loading,
                    showLoginForm,
                    loginError,
                    loginForm,
                    message,
                    stats,
                    lastRefreshTime,
                    activeTab,
                    
                    toggleDarkMode,
                    login,
                    logout,
                    fetchStats,
                    refreshData,
                    getCurrentTime,
                    formatTime,
                    
                    // 用户管理
                    userList,
                    userSearch,
                    userPage,
                    userPageSize,
                    usersLoading,
                    filteredUsers,
                    selectedUser,
                    showDisableUserModal,
                    showEnableUserModal,
                    showSendNotificationModal,
                    notificationForm,
                    
                    fetchUsers,
                    confirmDisableUser,
                    confirmEnableUser,
                    disableUser,
                    enableUser,
                    openSendNotificationModal,
                    sendNotification,
                    
                    // 服务管理
                    serviceList,
                    serviceSearch,
                    servicesLoading,
                    filteredServices,
                    selectedService,
                    showDisableServiceModal,
                    showEnableServiceModal,
                    showServiceDetailsModal,
                    
                    fetchServices,
                    confirmDisableService,
                    confirmEnableService,
                    disableService,
                    enableService,
                    showServiceDetails
                };
            }
        }).mount('#app');
    </script>
</body>
</html> 